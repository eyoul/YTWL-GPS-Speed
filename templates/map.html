<!DOCTYPE html>
<html>
<head>
    <title>GPS Tracker</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          crossorigin=""/>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            crossorigin=""></script>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        #map { 
            height: 100vh; 
            width: 100%; 
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <script>
        var map = null;
        var markers = {};

        // Initialize map when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeMap();
            // Update markers every 5 seconds
            setInterval(updateMarkers, 5000);
        });

        function initializeMap() {
            if (map) return;
            
            try {
                // Initialize the map
                map = L.map('map').setView([9.03, 38.74], 13); // Default to Addis Ababa with zoom level 13
                
                // Add OpenStreetMap tile layer
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                    maxZoom: 19
                }).addTo(map);
                
                console.log('Map initialized successfully');
                
                // Start updating markers
                updateMarkers();
            } catch (error) {
                console.error('Error initializing map:', error);
                document.getElementById('map').innerHTML = '<div style="padding: 20px; color: red;">Error loading map: ' + error.message + '</div>';
            }
        }

        async function updateMarkers() {
            if (!map) return;
            
            try {
                let res = await fetch('/api/latest');
                if (!res.ok) {
                    console.error('API response not ok:', res.status);
                    return;
                }
                let data = await res.json();
                
                console.log('Received data:', data);

                if (data && data.length > 0) {
                    let first = data[0];
                    map.setView([first.lat, first.lon], 13);
                }

                if (data && Array.isArray(data)) {
                    data.forEach(p => {
                        let key = p.imei;
                        if (markers[key]) {
                            // Update existing marker position
                            markers[key].setLatLng([p.lat, p.lon]);
                        } else {
                            // Create new marker
                            markers[key] = L.marker([p.lat, p.lon], {
                                title: `IMEI: ${p.imei}`
                            }).addTo(map);
                            
                            // Add popup
                            markers[key].bindPopup(`IMEI: ${p.imei}<br>Speed: ${p.speed} km/h`);
                        }
                    });
                }
            } catch (error) {
                console.error('Error updating markers:', error);
            }
        }
    </script>
</body>
</html>
