<!DOCTYPE html>
<html>
<head>
    <title>GPS Fleet Management Dashboard</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 1.8rem;
            font-weight: 600;
        }
        
        .container {
            display: flex;
            height: calc(100vh - 70px);
        }
        
        .sidebar {
            width: 300px;
            background: white;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            overflow-y: auto;
            transition: transform 0.3s ease;
        }
        
        .sidebar-section {
            padding: 1.5rem;
            border-bottom: 1px solid #eee;
        }
        
        .sidebar-section h3 {
            color: #333;
            margin-bottom: 1rem;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .sidebar-section h3 i {
            color: #667eea;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.3rem;
            color: #555;
            font-size: 0.9rem;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.6rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            width: 100%;
            margin-bottom: 0.5rem;
            transition: background 0.3s ease;
        }
        
        .btn:hover {
            background: #5a6fd8;
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .btn-primary {
            background: #667eea;
        }
        
        .btn-primary:hover {
            background: #5a6fd6;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .form-group label {
            font-weight: 600;
            color: #333;
            font-size: 0.9rem;
        }
        
        .form-group input,
        .form-group select {
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }
        
        .form-group input[readonly] {
            background: #f8f9fa;
            color: #6c757d;
        }
        
        .reports {
            width: calc(100% - 300px);
            display: flex;
            flex-direction: column;
        }
        
        .reports-header {
            background: white;
            padding: 1rem 2rem;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .reports-content {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
        }
        
        .report-card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .report-card h4 {
            color: #333;
            margin-bottom: 1rem;
            font-size: 1.2rem;
        }
        
        .report-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .stat-card {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 6px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #667eea;
        }
        
        .status-danger {
            color: #dc3545 !important;
        }
        
        .status-success {
            color: #28a745 !important;
        }
        
        .status-warning {
            color: #ffc107 !important;
        }
        
        .status-secondary {
            color: #6c757d !important;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9rem;
            margin-top: 0.3rem;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        
        .data-table th,
        .data-table td {
            padding: 0.8rem;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .data-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }
        
        .data-table tr:hover {
            background: #f8f9fa;
        }
        
        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
        }
        
        .toggle-btn {
            display: none;
            position: fixed;
            top: 1rem;
            left: 1rem;
            z-index: 1000;
            background: #667eea;
            color: white;
            border: none;
            padding: 0.5rem;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .badge {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .bg-success {
            background: #28a745;
            color: white;
        }
        
        .bg-warning {
            background: #ffc107;
            color: #212529;
        }
        
        .bg-info {
            background: #17a2b8;
            color: white;
        }
        
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: 0;
                top: 70px;
                height: calc(100vh - 70px);
                z-index: 999;
                transform: translateX(-100%);
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .reports {
                width: 100%;
            }
            
            .toggle-btn {
                display: block;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1><i class="fas fa-map-marked-alt"></i> GPS Fleet Management Dashboard</h1>
    </div>
    
    <button class="toggle-btn" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
    </button>
    
    <div class="container">
        <div class="sidebar" id="sidebar">
            <div class="sidebar-section">
                <h3><i class="fas fa-cog"></i> Report Settings</h3>
                <div class="form-group">
                    <label for="vehicleSelect">Select Vehicle:</label>
                    <select id="vehicleSelect">
                        <option value="">All Vehicles</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="startDate">Start Date:</label>
                    <input type="date" id="startDate">
                </div>
                <div class="form-group">
                    <label for="endDate">End Date:</label>
                    <input type="date" id="endDate">
                </div>
            </div>
            
            <div class="sidebar-section">
                <h3><i class="fas fa-chart-line"></i> Travel Reports</h3>
                <button class="btn" onclick="loadParkReport()">
                    <i class="fas fa-parking"></i> Park Report
                </button>
                <button class="btn" onclick="loadMileageReport()">
                    <i class="fas fa-road"></i> Daily Mileage
                </button>
                <button class="btn" onclick="loadFuelReport()">
                    <i class="fas fa-gas-pump"></i> Fuel Report
                </button>
                <button class="btn" onclick="loadTemperatureReport()">
                    <i class="fas fa-thermometer-half"></i> Temperature
                </button>
                <button class="btn" onclick="loadTripsReport()">
                    <i class="fas fa-route"></i> Trip Reports
                </button>
                <button class="btn btn-secondary" onclick="loadAllReports()">
                    <i class="fas fa-chart-bar"></i> Load All Reports
                </button>
            </div>
            
            <div class="sidebar-section">
                <h3><i class="fas fa-truck"></i> Vehicle Management</h3>
                <button class="btn" onclick="showVehicleManagement()">
                    <i class="fas fa-list"></i> Vehicle List
                </button>
                <button class="btn" onclick="showCreateVehicle()">
                    <i class="fas fa-plus"></i> Add Vehicle
                </button>
                <button class="btn btn-secondary" onclick="showVehicleStatistics()">
                    <i class="fas fa-chart-pie"></i> Statistics
                </button>
            </div>
            
            <div class="sidebar-section">
                <h3><i class="fas fa-car"></i> Vehicle Control</h3>
                <button class="btn" onclick="showEngineControl()">
                    <i class="fas fa-cogs"></i> Engine Control
                </button>
                <button class="btn" onclick="showSpeedLimitControl()">
                    <i class="fas fa-tachometer-alt"></i> Set Speed Limit
                </button>
                <button class="btn" onclick="showPositioning()">
                    <i class="fas fa-map-marker-alt"></i> Positioning
                </button>
            </div>
            
            <div class="sidebar-section">
                <h3><i class="fas fa-bell"></i> System Management</h3>
                <button class="btn" onclick="showAlarmLogs()">
                    <i class="fas fa-exclamation-triangle"></i> Alarm Logs
                </button>
                <button class="btn" onclick="showTripRequests()">
                    <i class="fas fa-clipboard-list"></i> Trip Requests
                </button>
            </div>
            
            <div class="sidebar-section">
                <h3><i class="fas fa-map"></i> Navigation</h3>
                <button class="btn" onclick="showLiveMap()">
                    <i class="fas fa-satellite-dish"></i> Live Map
                </button>
                <button class="btn btn-secondary" onclick="window.open('/map', '_blank')">
                    <i class="fas fa-external-link-alt"></i> Open Map in New Tab
                </button>
            </div>
        </div>
        
        <div class="reports">
            <div class="reports-header">
                <h2 id="reportTitle">Dashboard Overview</h2>
                <div id="reportStatus"></div>
            </div>
            
            <div class="reports-content" id="reportsContent">
                <div class="report-card">
                    <h4><i class="fas fa-tachometer-alt"></i> Fleet Overview</h4>
                    <div class="report-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="totalVehicles">-</div>
                            <div class="stat-label">Active Vehicles</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="totalDistance">-</div>
                            <div class="stat-label">Total Miles Today</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="avgSpeed">-</div>
                            <div class="stat-label">Average Speed</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="activeTime">-</div>
                            <div class="stat-label">Active Hours</div>
                        </div>
                    </div>
                </div>
                
                <div class="report-card">
                    <h4><i class="fas fa-info-circle"></i> Quick Start</h4>
                    <p>Welcome to your GPS Fleet Management Dashboard! Select a vehicle IMEI and choose your desired date range, then click on any report button to view detailed analytics.</p>
                    <ul style="margin-top: 1rem; padding-left: 1.5rem; color: #666;">
                        <li><strong>Park Report:</strong> View vehicle stoppages and idling instances</li>
                        <li><strong>Daily Mileage:</strong> Track miles driven per day</li>
                        <li><strong>Fuel Report:</strong> Monitor fuel consumption</li>
                        <li><strong>Temperature:</strong> Check temperature-sensitive product monitoring</li>
                        <li><strong>Trip Reports:</strong> Analyze routes, distances, and speeds</li>
                        <li><strong>Live Map:</strong> View real-time vehicle locations</li>
                    </ul>
                    <div style="margin-top: 1rem;">
                        <strong>Quick Links:</strong> 
                        <a href="/map" target="_blank" style="color: #667eea; text-decoration: none; margin-left: 0.5rem;">
                            <i class="fas fa-map"></i> Open Map View
                        </a>
                    </div>
                </div>
                
                <div id="liveMapContainer" style="display: none;">
                    <div class="report-card">
                        <h4><i class="fas fa-map-marked-alt"></i> Live Vehicle Tracking</h4>
                        <div id="map" style="height: 500px; border-radius: 8px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        let map = null;
        let markers = {};
        
        // Initialize date inputs with today's date
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('startDate').value = today;
            document.getElementById('endDate').value = today;
            
            // Load initial overview data
            loadOverviewData();
        });
        
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
        }
        
        function getReportParams() {
            const vehicleSelect = document.getElementById('vehicleSelect');
            const imei = vehicleSelect.value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (!imei) {
                showError('Please select a vehicle');
                return null;
            }
            
            const params = new URLSearchParams({ imei });
            if (startDate) params.append('start_date', startDate);
            if (endDate) params.append('end_date', endDate);
            
            return params;
        }
        
        async function loadOverviewData() {
            try {
                const response = await fetch('/api/latest');
                const data = await response.json();
                
                // Calculate overview statistics
                const uniqueImeis = [...new Set(data.map(p => p.imei))];
                const totalDistance = data.reduce((sum, p) => sum + (p.speed || 0), 0);
                const avgSpeed = data.length > 0 ? (data.reduce((sum, p) => sum + (p.speed || 0), 0) / data.length).toFixed(1) : 0;
                
                document.getElementById('totalVehicles').textContent = uniqueImeis.length;
                document.getElementById('totalDistance').textContent = Math.round(totalDistance * 0.1);
                document.getElementById('avgSpeed').textContent = avgSpeed;
                document.getElementById('activeTime').textContent = Math.round(data.length * 0.05);
                
                // Load vehicles for dropdowns
                loadVehicleDropdown('vehicleSelect');
            } catch (error) {
                console.error('Error loading overview data:', error);
            }
        }
        
        async function loadParkReport() {
            const params = getReportParams();
            if (!params) return;
            
            showLoading('Loading Park Report...');
            updateTitle('Park Report - Vehicle Stoppages & Idling');
            
            try {
                const response = await fetch(`/api/reports/parking?${params}`);
                const data = await response.json();
                
                if (response.ok) {
                    displayParkReport(data);
                } else {
                    showError(data.error || 'Failed to load park report');
                }
            } catch (error) {
                showError('Error loading park report: ' + error.message);
            }
        }
        
        function displayParkReport(data) {
            const html = `
                <div class="report-card">
                    <h4><i class="fas fa-parking"></i> Park Report Summary</h4>
                    <div class="report-grid">
                        <div class="stat-card">
                            <div class="stat-value">${data.total_events}</div>
                            <div class="stat-label">Total Events</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${data.parking_events.filter(e => e.event_type === 'parked').length}</div>
                            <div class="stat-label">Parked Events</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${data.parking_events.filter(e => e.event_type === 'idling').length}</div>
                            <div class="stat-label">Idling Events</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${Math.round(data.parking_events.reduce((sum, e) => sum + e.duration_minutes, 0) / 60)}h</div>
                            <div class="stat-label">Total Duration</div>
                        </div>
                    </div>
                </div>
                
                <div class="report-card">
                    <h4><i class="fas fa-list"></i> Detailed Events</h4>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Start Time</th>
                                <th>End Time</th>
                                <th>Duration</th>
                                <th>Type</th>
                                <th>Location</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.parking_events.map(event => `
                                <tr>
                                    <td>${new Date(event.start_time).toLocaleString()}</td>
                                    <td>${new Date(event.end_time).toLocaleString()}</td>
                                    <td>${event.duration_minutes} min</td>
                                    <td><span class="badge ${event.event_type === 'parked' ? 'bg-success' : 'bg-warning'}">${event.event_type}</span></td>
                                    <td>${event.latitude.toFixed(4)}, ${event.longitude.toFixed(4)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            document.getElementById('reportsContent').innerHTML = html;
        }
        
        async function loadMileageReport() {
            const params = getReportParams();
            if (!params) return;
            
            showLoading('Loading Daily Mileage Report...');
            updateTitle('Daily Mileage Report');
            
            try {
                const response = await fetch(`/api/reports/mileage?${params}`);
                const data = await response.json();
                
                if (response.ok) {
                    displayMileageReport(data);
                } else {
                    showError(data.error || 'Failed to load mileage report');
                }
            } catch (error) {
                showError('Error loading mileage report: ' + error.message);
            }
        }
        
        function displayMileageReport(data) {
            const html = `
                <div class="report-card">
                    <h4><i class="fas fa-road"></i> Mileage Summary</h4>
                    <div class="report-grid">
                        <div class="stat-card">
                            <div class="stat-value">${data.total_miles}</div>
                            <div class="stat-label">Total Miles</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${data.daily_mileage.length}</div>
                            <div class="stat-label">Active Days</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${data.daily_mileage.length > 0 ? (data.total_miles / data.daily_mileage.length).toFixed(1) : 0}</div>
                            <div class="stat-label">Daily Average</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${data.daily_mileage.length > 0 ? Math.max(...data.daily_mileage.map(d => d.miles)).toFixed(1) : 0}</div>
                            <div class="stat-label">Max Daily Miles</div>
                        </div>
                    </div>
                </div>
                
                <div class="report-card">
                    <h4><i class="fas fa-calendar-alt"></i> Daily Breakdown</h4>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Miles Driven</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.daily_mileage.map(day => `
                                <tr>
                                    <td>${day.date}</td>
                                    <td>${day.miles}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            document.getElementById('reportsContent').innerHTML = html;
        }
        
        async function loadFuelReport() {
            const params = getReportParams();
            if (!params) return;
            
            showLoading('Loading Fuel Report...');
            updateTitle('Fuel Consumption Report');
            
            try {
                const response = await fetch(`/api/reports/fuel?${params}`);
                const data = await response.json();
                
                if (response.ok) {
                    displayFuelReport(data);
                } else {
                    showError(data.error || 'Failed to load fuel report');
                }
            } catch (error) {
                showError('Error loading fuel report: ' + error.message);
            }
        }
        
        function displayFuelReport(data) {
            const html = `
                <div class="report-card">
                    <h4><i class="fas fa-gas-pump"></i> Fuel Summary</h4>
                    <div class="report-grid">
                        <div class="stat-card">
                            <div class="stat-value">${data.total_filled}</div>
                            <div class="stat-label">Total Filled</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${data.total_drained}</div>
                            <div class="stat-label">Total Drained</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${data.net_consumption}</div>
                            <div class="stat-label">Net Consumption</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${data.fuel_data.length}</div>
                            <div class="stat-label">Data Points</div>
                        </div>
                    </div>
                </div>
                
                <div class="report-card">
                    <h4><i class="fas fa-chart-line"></i> Fuel History</h4>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>Fuel Level</th>
                                <th>Filled</th>
                                <th>Drained</th>
                                <th>Event Type</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.fuel_data.map(item => `
                                <tr>
                                    <td>${new Date(item.timestamp).toLocaleString()}</td>
                                    <td>${item.fuel_level || '-'}</td>
                                    <td>${item.fuel_filled || 0}</td>
                                    <td>${item.fuel_drained || 0}</td>
                                    <td><span class="badge bg-info">${item.event_type}</span></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            document.getElementById('reportsContent').innerHTML = html;
        }
        
        async function loadTemperatureReport() {
            const params = getReportParams();
            if (!params) return;
            
            showLoading('Loading Temperature Report...');
            updateTitle('Temperature Monitoring Report');
            
            try {
                const response = await fetch(`/api/reports/temperature?${params}`);
                const data = await response.json();
                
                if (response.ok) {
                    displayTemperatureReport(data);
                } else {
                    showError(data.error || 'Failed to load temperature report');
                }
            } catch (error) {
                showError('Error loading temperature report: ' + error.message);
            }
        }
        
        function displayTemperatureReport(data) {
            const html = `
                <div class="report-card">
                    <h4><i class="fas fa-thermometer-half"></i> Temperature Summary</h4>
                    <div class="report-grid">
                        <div class="stat-card">
                            <div class="stat-value">${data.average_temperature || '-'}</div>
                            <div class="stat-label">Average Temp (°C)</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${data.min_temperature || '-'}</div>
                            <div class="stat-label">Min Temp (°C)</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${data.max_temperature || '-'}</div>
                            <div class="stat-label">Max Temp (°C)</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${data.readings_count}</div>
                            <div class="stat-label">Total Readings</div>
                        </div>
                    </div>
                </div>
                
                <div class="report-card">
                    <h4><i class="fas fa-temperature-high"></i> Temperature History</h4>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>Temperature (°C)</th>
                                <th>Sensor ID</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.temperature_data.map(item => `
                                <tr>
                                    <td>${new Date(item.timestamp).toLocaleString()}</td>
                                    <td>${item.temperature_celsius || '-'}</td>
                                    <td>${item.sensor_id || '-'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            document.getElementById('reportsContent').innerHTML = html;
        }
        
        async function loadTripsReport() {
            const params = getReportParams();
            if (!params) return;
            
            showLoading('Loading Trip Reports...');
            updateTitle('Trip Reports - Routes & Speed Analysis');
            
            try {
                const response = await fetch(`/api/reports/trips?${params}`);
                const data = await response.json();
                
                if (response.ok) {
                    displayTripsReport(data);
                } else {
                    showError(data.error || 'Failed to load trips report');
                }
            } catch (error) {
                showError('Error loading trips report: ' + error.message);
            }
        }
        
        function displayTripsReport(data) {
            const html = `
                <div class="report-card">
                    <h4><i class="fas fa-route"></i> Trip Summary</h4>
                    <div class="report-grid">
                        <div class="stat-card">
                            <div class="stat-value">${data.total_trips}</div>
                            <div class="stat-label">Total Trips</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${data.total_distance_miles}</div>
                            <div class="stat-label">Total Distance (miles)</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${Math.round(data.total_duration_minutes / 60)}h</div>
                            <div class="stat-label">Total Duration</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${data.total_trips > 0 ? (data.total_distance_miles / data.total_trips).toFixed(1) : 0}</div>
                            <div class="stat-label">Avg Trip Distance</div>
                        </div>
                    </div>
                </div>
                
                <div class="report-card">
                    <h4><i class="fas fa-list"></i> Detailed Trips</h4>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Start Time</th>
                                <th>Duration</th>
                                <th>Distance</th>
                                <th>Avg Speed</th>
                                <th>Max Speed</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.trips.map(trip => `
                                <tr>
                                    <td>${new Date(trip.start_time).toLocaleString()}</td>
                                    <td>${trip.duration_minutes} min</td>
                                    <td>${trip.distance_miles} miles</td>
                                    <td>${trip.avg_speed} km/h</td>
                                    <td>${trip.max_speed} km/h</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            document.getElementById('reportsContent').innerHTML = html;
        }
        
        async function loadAllReports() {
            const params = getReportParams();
            if (!params) return;
            
            showLoading('Loading All Reports...');
            updateTitle('Complete Fleet Reports');
            
            try {
                const [parking, mileage, fuel, temperature, trips] = await Promise.all([
                    fetch(`/api/reports/parking?${params}`).then(r => r.json()),
                    fetch(`/api/reports/mileage?${params}`).then(r => r.json()),
                    fetch(`/api/reports/fuel?${params}`).then(r => r.json()),
                    fetch(`/api/reports/temperature?${params}`).then(r => r.json()),
                    fetch(`/api/reports/trips?${params}`).then(r => r.json())
                ]);
                
                displayAllReports({ parking, mileage, fuel, temperature, trips });
            } catch (error) {
                showError('Error loading reports: ' + error.message);
            }
        }
        
        function displayAllReports(data) {
            const html = `
                <div class="report-card">
                    <h4><i class="fas fa-chart-bar"></i> Complete Fleet Overview</h4>
                    <div class="report-grid">
                        <div class="stat-card">
                            <div class="stat-value">${data.parking.total_events}</div>
                            <div class="stat-label">Parking Events</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${data.mileage.total_miles}</div>
                            <div class="stat-label">Total Miles</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${data.fuel.net_consumption}</div>
                            <div class="stat-label">Fuel Consumed</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${data.trips.total_trips}</div>
                            <div class="stat-label">Total Trips</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${data.temperature.average_temperature || '-'}</div>
                            <div class="stat-label">Avg Temp (°C)</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${Math.round(data.trips.total_duration_minutes / 60)}h</div>
                            <div class="stat-label">Total Duration</div>
                        </div>
                    </div>
                </div>
                
                <div class="success">
                    <i class="fas fa-check-circle"></i> All reports loaded successfully! Scroll down to see detailed information for each report type.
                </div>
                
                ${getParkReportHTML(data.parking)}
                ${getMileageReportHTML(data.mileage)}
                ${getFuelReportHTML(data.fuel)}
                ${getTemperatureReportHTML(data.temperature)}
                ${getTripsReportHTML(data.trips)}
            `;
            
            document.getElementById('reportsContent').innerHTML = html;
        }
        
        function getParkReportHTML(data) {
            return `
                <div class="report-card">
                    <h4><i class="fas fa-parking"></i> Park Report Details</h4>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Start Time</th>
                                <th>End Time</th>
                                <th>Duration</th>
                                <th>Type</th>
                                <th>Location</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.parking_events.map(event => `
                                <tr>
                                    <td>${new Date(event.start_time).toLocaleString()}</td>
                                    <td>${new Date(event.end_time).toLocaleString()}</td>
                                    <td>${event.duration_minutes} min</td>
                                    <td><span class="badge ${event.event_type === 'parked' ? 'bg-success' : 'bg-warning'}">${event.event_type}</span></td>
                                    <td>${event.latitude.toFixed(4)}, ${event.longitude.toFixed(4)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        function getMileageReportHTML(data) {
            return `
                <div class="report-card">
                    <h4><i class="fas fa-road"></i> Daily Mileage Details</h4>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Miles Driven</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.daily_mileage.map(day => `
                                <tr>
                                    <td>${day.date}</td>
                                    <td>${day.miles}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        function getFuelReportHTML(data) {
            return `
                <div class="report-card">
                    <h4><i class="fas fa-gas-pump"></i> Fuel History Details</h4>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>Fuel Level</th>
                                <th>Filled</th>
                                <th>Drained</th>
                                <th>Event Type</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.fuel_data.map(item => `
                                <tr>
                                    <td>${new Date(item.timestamp).toLocaleString()}</td>
                                    <td>${item.fuel_level || '-'}</td>
                                    <td>${item.fuel_filled || 0}</td>
                                    <td>${item.fuel_drained || 0}</td>
                                    <td><span class="badge bg-info">${item.event_type}</span></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        function getTemperatureReportHTML(data) {
            return `
                <div class="report-card">
                    <h4><i class="fas fa-thermometer-half"></i> Temperature History Details</h4>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>Temperature (°C)</th>
                                <th>Sensor ID</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.temperature_data.map(item => `
                                <tr>
                                    <td>${new Date(item.timestamp).toLocaleString()}</td>
                                    <td>${item.temperature_celsius || '-'}</td>
                                    <td>${item.sensor_id || '-'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        function getTripsReportHTML(data) {
            return `
                <div class="report-card">
                    <h4><i class="fas fa-route"></i> Trip History Details</h4>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Start Time</th>
                                <th>Duration</th>
                                <th>Distance</th>
                                <th>Avg Speed</th>
                                <th>Max Speed</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.trips.map(trip => `
                                <tr>
                                    <td>${new Date(trip.start_time).toLocaleString()}</td>
                                    <td>${trip.duration_minutes} min</td>
                                    <td>${trip.distance_miles} miles</td>
                                    <td>${trip.avg_speed} km/h</td>
                                    <td>${trip.max_speed} km/h</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        function showEngineControl() {
            updateTitle('Engine Control');
            const html = `
                <div class="report-card">
                    <h4><i class="fas fa-cogs"></i> Vehicle Engine Control</h4>
                    <div class="form-group">
                        <label for="engineVehicle">Select Vehicle:</label>
                        <select id="engineVehicle">
                            <option value="">Select a vehicle</option>
                        </select>
                    </div>
                    <div class="report-grid">
                        <button class="btn" onclick="cutEngine()">
                            <i class="fas fa-power-off"></i> Cut Engine
                        </button>
                        <button class="btn" onclick="startEngine()">
                            <i class="fas fa-play"></i> Start Engine
                        </button>
                        <button class="btn btn-secondary" onclick="checkEngineStatus()">
                            <i class="fas fa-info-circle"></i> Check Status
                        </button>
                    </div>
                    <div id="engineStatus"></div>
                </div>
                
                <div id="engineHistoryContainer" style="display: none;">
                    <div class="report-card">
                        <h4><i class="fas fa-history"></i> Engine Command History</h4>
                        <div id="engineHistory"></div>
                    </div>
                </div>
            `;
            document.getElementById('reportsContent').innerHTML = html;
            loadVehicleDropdown('engineVehicle');
        }
        
        function showSpeedLimitControl() {
            updateTitle('Speed Limit Control');
            const html = `
                <div class="report-card">
                    <h4><i class="fas fa-tachometer-alt"></i> Set Vehicle Speed Limit</h4>
                    <div class="form-group">
                        <label for="speedVehicle">Select Vehicle:</label>
                        <select id="speedVehicle">
                            <option value="">Select a vehicle</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="speedLimit">Speed Limit (km/h):</label>
                        <input type="number" id="speedLimit" placeholder="Enter speed limit" min="0" max="200">
                    </div>
                    <div class="form-group">
                        <label for="setBy">Set By:</label>
                        <input type="text" id="setBy" placeholder="Your name">
                    </div>
                    <button class="btn" onclick="setSpeedLimit()">
                        <i class="fas fa-check"></i> Set Speed Limit
                    </button>
                    <button class="btn btn-secondary" onclick="getCurrentSpeedLimit()">
                        <i class="fas fa-search"></i> Get Current Limit
                    </button>
                    <div id="speedLimitStatus"></div>
                </div>
                
                <div id="currentSpeedLimitContainer" style="display: none;">
                    <div class="report-card">
                        <h4><i class="fas fa-info"></i> Current Speed Limit</h4>
                        <div id="currentSpeedLimit"></div>
                    </div>
                </div>
            `;
            document.getElementById('reportsContent').innerHTML = html;
            loadVehicleDropdown('speedVehicle');
        }
        
        function showPositioning() {
            updateTitle('Vehicle Positioning');
            const html = `
                <div class="report-card">
                    <h4><i class="fas fa-map-marker-alt"></i> Vehicle Positioning Data</h4>
                    <div class="form-group">
                        <label for="positionVehicle">Select Vehicle:</label>
                        <select id="positionVehicle">
                            <option value="">Select a vehicle</option>
                        </select>
                    </div>
                    <button class="btn" onclick="getPositioningData()">
                        <i class="fas fa-search"></i> Get Positioning Data
                    </button>
                    <div id="positioningStatus"></div>
                </div>
                
                <div id="positioningDataContainer" style="display: none;">
                    <div class="report-card">
                        <h4><i class="fas fa-location-arrow"></i> Position Information</h4>
                        <div id="positioningData"></div>
                    </div>
                </div>
            `;
            document.getElementById('reportsContent').innerHTML = html;
            loadVehicleDropdown('positionVehicle');
        }
        
        function showAlarmLogs() {
            updateTitle('Alarm Logs');
            const html = `
                <div class="report-card">
                    <h4><i class="fas fa-exclamation-triangle"></i> System Alarm Logs</h4>
                    <div class="form-group">
                        <label for="alarmVehicle">Filter by Vehicle (optional):</label>
                        <select id="alarmVehicle">
                            <option value="">All Vehicles</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="alarmLimit">Number of records:</label>
                        <input type="number" id="alarmLimit" value="100" min="1" max="1000">
                    </div>
                    <button class="btn" onclick="loadAlarmLogs()">
                        <i class="fas fa-search"></i> Load Alarm Logs
                    </button>
                    <div id="alarmStatus"></div>
                </div>
                
                <div id="alarmLogsContainer" style="display: none;">
                    <div class="report-card">
                        <h4><i class="fas fa-list"></i> Alarm History</h4>
                        <div id="alarmLogs"></div>
                    </div>
                </div>
            `;
            document.getElementById('reportsContent').innerHTML = html;
            loadVehicleDropdown('alarmVehicle');
        }
        
        function showTripRequests() {
            updateTitle('Trip Requests Management');
            const html = `
                <div class="report-card">
                    <h4><i class="fas fa-clipboard-list"></i> Trip Request Management</h4>
                    <div class="form-group">
                        <label for="requestStatus">Filter by Status:</label>
                        <select id="requestStatus">
                            <option value="">All Requests</option>
                            <option value="pending">Pending</option>
                            <option value="approved">Approved</option>
                            <option value="rejected">Rejected</option>
                        </select>
                    </div>
                    <button class="btn" onclick="loadTripRequests()">
                        <i class="fas fa-search"></i> Load Trip Requests
                    </button>
                    <button class="btn" onclick="showCreateTripRequest()">
                        <i class="fas fa-plus"></i> Create New Request
                    </button>
                    <div id="tripRequestStatus"></div>
                </div>
                
                <div id="tripRequestsContainer" style="display: none;">
                    <div class="report-card">
                        <h4><i class="fas fa-list"></i> Trip Requests</h4>
                        <div id="tripRequests"></div>
                    </div>
                </div>
                
                <div id="createTripRequestContainer" style="display: none;">
                    <div class="report-card">
                        <h4><i class="fas fa-plus"></i> Create Trip Request</h4>
                        <div class="form-group">
                            <label for="department">Department:</label>
                            <input type="text" id="department" placeholder="Enter department name">
                        </div>
                        <div class="form-group">
                            <label for="requesterName">Requester Name:</label>
                            <input type="text" id="requesterName" placeholder="Enter your name">
                        </div>
                        <div class="form-group">
                            <label for="purpose">Purpose:</label>
                            <input type="text" id="purpose" placeholder="Enter trip purpose">
                        </div>
                        <div class="form-group">
                            <label for="destination">Destination:</label>
                            <input type="text" id="destination" placeholder="Enter destination">
                        </div>
                        <button class="btn" onclick="createTripRequest()">
                            <i class="fas fa-check"></i> Submit Request
                        </button>
                        <button class="btn btn-secondary" onclick="cancelTripRequest()">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <div id="createTripStatus"></div>
                    </div>
                </div>
            `;
            document.getElementById('reportsContent').innerHTML = html;
        }
        
        async function cutEngine() {
            const vehicleSelect = document.getElementById('engineVehicle');
            const imei = vehicleSelect.value;
            
            if (!imei) {
                showError('Please select a vehicle');
                return;
            }
            
            showLoading('Cutting engine...');
            
            try {
                const response = await fetch('/api/engine/cut', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ imei })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showSuccess('Engine cut command sent successfully!');
                    checkEngineStatus();
                } else {
                    showError(data.error || 'Failed to cut engine');
                }
            } catch (error) {
                showError('Error: ' + error.message);
            }
        }
        
        async function startEngine() {
            const vehicleSelect = document.getElementById('engineVehicle');
            const imei = vehicleSelect.value;
            
            if (!imei) {
                showError('Please select a vehicle');
                return;
            }
            
            showLoading('Starting engine...');
            
            try {
                const response = await fetch('/api/engine/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ imei })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showSuccess('Engine start command sent successfully!');
                    checkEngineStatus();
                } else {
                    showError(data.error || 'Failed to start engine');
                }
            } catch (error) {
                showError('Error: ' + error.message);
            }
        }

async function checkEngineStatus() {
    const vehicleSelect = document.getElementById('engineVehicle');
    const imei = vehicleSelect.value;
    
    if (!imei) {
        showError('Please select a vehicle');
        return;
    }
    
    showLoading('Checking engine status...');
    
    try {
        const response = await fetch(`/api/engine/status?imei=${imei}`);
        const data = await response.json();
        
        if (response.ok) {
            displayEngineStatus(data.status);
        } else {
            showError(data.error || 'Failed to check engine status');
        }
    } catch (error) {
        showError('Error: ' + error.message);
    }
}

function displayEngineStatus(status) {
    const container = document.getElementById('engineStatus');
    
    // Determine status color and icon
    let statusClass = '';
    let statusIcon = '';
    
    if (status === 'Cut') {
        statusClass = 'status-danger';
        statusIcon = 'fa-power-off';
    } else if (status === 'Active') {
        statusClass = 'status-success';
        statusIcon = 'fa-play';
    } else if (status.includes('Processing')) {
        statusClass = 'status-warning';
        statusIcon = 'fa-spinner fa-spin';
    } else if (status.includes('Failed')) {
        statusClass = 'status-danger';
        statusIcon = 'fa-exclamation-triangle';
    } else {
        statusClass = 'status-secondary';
        statusIcon = 'fa-question';
    }
    
    container.innerHTML = `
        <div class="report-grid">
            <div class="stat-card">
                <div class="stat-value ${statusClass}">
                    <i class="fas ${statusIcon}"></i> ${status}
                </div>
                <div class="stat-label">Engine Status</div>
            </div>
        </div>
    `;
}

// Speed Limit Functions
async function setSpeedLimit() {
    const vehicleSelect = document.getElementById('speedVehicle');
    const imei = vehicleSelect.value;
    const speedLimit = document.getElementById('speedLimit').value;
    const setBy = document.getElementById('setBy').value;
    
    if (!imei) {
        showError('Please select a vehicle');
        return;
    }
    
    if (!speedLimit || speedLimit <= 0) {
        showError('Please enter a valid speed limit');
        return;
    }
    
    if (!setBy) {
        showError('Please enter who is setting this limit');
        return;
    }
    
    showLoading('Setting speed limit...');
    
    try {
        const response = await fetch('/api/speed_limit', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ imei, speed_limit: parseInt(speedLimit), set_by: setBy })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            showSuccess('Speed limit set successfully!');
            getCurrentSpeedLimit();
        } else {
            showError(data.error || 'Failed to set speed limit');
        }
    } catch (error) {
        showError('Error: ' + error.message);
    }
}

async function getCurrentSpeedLimit() {
    const vehicleSelect = document.getElementById('speedVehicle');
    const imei = vehicleSelect.value;
    
    if (!imei) {
        showError('Please select a vehicle');
        return;
    }
    
    showLoading('Getting current speed limit...');
    
    try {
        const response = await fetch(`/api/speed_limit?imei=${imei}`);
        const data = await response.json();
        
        if (response.ok) {
            displayCurrentSpeedLimit(data.speed_limit);
        } else {
            showError(data.error || 'Failed to get speed limit');
        }
    } catch (error) {
        showError('Error: ' + error.message);
    }
}

function displayCurrentSpeedLimit(speedLimitData) {
    const container = document.getElementById('currentSpeedLimitContainer');
    const content = document.getElementById('currentSpeedLimit');
    
    if (!speedLimitData) {
        content.innerHTML = '<p>No speed limit set for this vehicle.</p>';
    } else {
        content.innerHTML = `
            <div class="report-grid">
                <div class="stat-card">
                    <div class="stat-value">${speedLimitData.speed_limit}</div>
                    <div class="stat-label">Speed Limit</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${speedLimitData.set_by}</div>
                    <div class="stat-label">Set By</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${new Date(speedLimitData.set_at).toLocaleString()}</div>
                    <div class="stat-label">Set At</div>
                </div>
            </div>
        `;
    }
    
    container.style.display = 'block';
}

// Positioning Functions
async function getPositioningData() {
    const vehicleSelect = document.getElementById('positionVehicle');
    const imei = vehicleSelect.value;
    
    if (!imei) {
        showError('Please select a vehicle');
        return;
    }
    
    showLoading('Getting positioning data...');
    
    try {
        const response = await fetch(`/api/positioning?imei=${imei}`);
        const data = await response.json();
        
        if (response.ok) {
            displayPositioningData(data.positioning_data);
        } else {
            showError(data.error || 'Failed to get positioning data');
        }
    } catch (error) {
        showError('Error: ' + error.message);
    }
}

function displayPositioningData(positioningData) {
    const container = document.getElementById('positioningDataContainer');
    const content = document.getElementById('positioningData');
    
    if (!positioningData) {
        content.innerHTML = '<p>No positioning data available for this vehicle.</p>';
    } else {
        const html = `
            <div class="report-grid">
                <div class="stat-card">
                    <div class="stat-value">${positioningData.current_latitude.toFixed(6)}</div>
                    <div class="stat-label">Current Latitude</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${positioningData.current_longitude.toFixed(6)}</div>
                    <div class="stat-label">Current Longitude</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${positioningData.last_latitude.toFixed(6)}</div>
                    <div class="stat-label">Last Latitude</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${positioningData.last_longitude.toFixed(6)}</div>
                    <div class="stat-label">Last Longitude</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${positioningData.heading || '-'}</div>
                    <div class="stat-label">Heading</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${positioningData.altitude || '-'}</div>
                    <div class="stat-label">Altitude</div>
                </div>
            </div>
            <p style="margin-top: 1rem;"><strong>Last Update:</strong> ${new Date(positioningData.timestamp).toLocaleString()}</p>
        `;
        content.innerHTML = html;
    }
    
    container.style.display = 'block';
}

// Alarm Functions
async function loadAlarmLogs() {
    const vehicleSelect = document.getElementById('alarmVehicle');
    const imei = vehicleSelect.value || undefined;
    const limit = parseInt(document.getElementById('alarmLimit').value) || 100;
    
    showLoading('Loading alarm logs...');
    
    try {
        const params = new URLSearchParams();
        if (imei) params.append('imei', imei);
        params.append('limit', limit);
        
        const response = await fetch(`/api/alarms?${params}`);
        const data = await response.json();
        
        if (response.ok) {
            displayAlarmLogs(data.alarms);
        } else {
            showError(data.error || 'Failed to load alarm logs');
        }
    } catch (error) {
        showError('Error: ' + error.message);
    }
}

function displayAlarmLogs(alarms) {
    const container = document.getElementById('alarmLogsContainer');
    const content = document.getElementById('alarmLogs');
    
    if (!alarms || alarms.length === 0) {
        content.innerHTML = '<p>No alarm logs available.</p>';
    } else {
        const html = `
            <table class="data-table">
                <thead>
                    <tr>
                        <th>IMEI</th>
                        <th>Alarm Type</th>
                        <th>Message</th>
                        <th>Timestamp</th>
                        <th>Acknowledged</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    ${alarms.map(alarm => `
                        <tr>
                            <td>${alarm.imei}</td>
                            <td><span class="badge bg-warning">${alarm.alarm_type}</span></td>
                            <td>${alarm.message}</td>
                            <td>${new Date(alarm.timestamp).toLocaleString()}</td>
                            <td>
                                ${alarm.acknowledged ? 
                                    `<span class="badge bg-success">Yes (${alarm.acknowledged_by})</span>` : 
                                    '<span class="badge bg-danger">No</span>'}
                            </td>
                            <td>
                                ${!alarm.acknowledged ? 
                                    `<button class="btn" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;" onclick="acknowledgeAlarm('${alarm.imei}', ${alarm.id})">
                                        <i class="fas fa-check"></i> Acknowledge
                                    </button>` : 
                                    '-'}
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
        content.innerHTML = html;
    }
    
    container.style.display = 'block';
}

async function acknowledgeAlarm(imei, alarmId) {
    showLoading('Acknowledging alarm...');
    
    try {
        const response = await fetch('/api/alarms/acknowledge', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ imei, alarm_id: alarmId, acknowledged_by: 'dashboard_user' })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            showSuccess('Alarm acknowledged successfully!');
            // Reload alarm logs
            loadAlarmLogs();
        } else {
            showError(data.error || 'Failed to acknowledge alarm');
        }
    } catch (error) {
        showError('Error: ' + error.message);
    }
}
        
        function displayAlarmLogs(alarms) {
            const container = document.getElementById('alarmLogsContainer');
            const content = document.getElementById('alarmLogs');
            
            if (!alarms || alarms.length === 0) {
                content.innerHTML = '<p>No alarm logs available.</p>';
            } else {
                const html = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>IMEI</th>
                                <th>Alarm Type</th>
                                <th>Message</th>
                                <th>Timestamp</th>
                                <th>Acknowledged</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${alarms.map(alarm => `
                                <tr>
                                    <td>${alarm.imei}</td>
                                    <td><span class="badge bg-warning">${alarm.alarm_type}</span></td>
                                    <td>${alarm.message}</td>
                                    <td>${new Date(alarm.timestamp).toLocaleString()}</td>
                                    <td>
                                        ${alarm.acknowledged ? 
                                            `<span class="badge bg-success">Yes (${alarm.acknowledged_by})</span>` : 
                                            '<span class="badge bg-danger">No</span>'}
                                    </td>
                                    <td>
                                        ${!alarm.acknowledged ? 
                                            `<button class="btn" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;" onclick="acknowledgeAlarm('${alarm.imei}', ${alarm.id})">
                                                <i class="fas fa-check"></i> Acknowledge
                                            </button>` : 
                                            '-'}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                content.innerHTML = html;
            }
            
            container.style.display = 'block';
        }
        
        async function acknowledgeAlarm(imei, alarmId) {
            showLoading('Acknowledging alarm...');
            
            try {
                const response = await fetch('/api/alarms/acknowledge', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ imei, alarm_id: alarmId, acknowledged_by: 'dashboard_user' })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showSuccess('Alarm acknowledged successfully!');
                    // Reload alarm logs
                    loadAlarmLogs();
                } else {
                    showError(data.error || 'Failed to acknowledge alarm');
                }
            } catch (error) {
                showError('Error: ' + error.message);
            }
        }
        
        // Trip Request Functions
        async function loadTripRequests() {
            const status = document.getElementById('requestStatus').value;
            
            showLoading('Loading trip requests...');
            
            try {
                const params = status ? new URLSearchParams({ status }) : '';
                const response = await fetch(`/api/trip_requests${params ? '?' + params.toString() : ''}`);
                const data = await response.json();
                
                if (response.ok) {
                    displayTripRequests(data.trip_requests);
                } else {
                    showError(data.error || 'Failed to load trip requests');
                }
            } catch (error) {
                showError('Error: ' + error.message);
            }
        }
        
        function displayTripRequests(requests) {
            const container = document.getElementById('tripRequestsContainer');
            const content = document.getElementById('tripRequests');
            
            if (!requests || requests.length === 0) {
                content.innerHTML = '<p>No trip requests found.</p>';
            } else {
                const html = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Department</th>
                                <th>Requester</th>
                                <th>Purpose</th>
                                <th>Destination</th>
                                <th>Status</th>
                                <th>Request Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${requests.map(req => `
                                <tr>
                                    <td>${req.id}</td>
                                    <td>${req.department}</td>
                                    <td>${req.requester_name}</td>
                                    <td>${req.purpose}</td>
                                    <td>${req.destination}</td>
                                    <td><span class="badge ${getStatusBadgeClass(req.status)}">${req.status}</span></td>
                                    <td>${new Date(req.request_date).toLocaleString()}</td>
                                    <td>
                                        ${req.status === 'pending' ? 
                                            `<button class="btn" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;" onclick="showApproveRequest(${req.id})">
                                                <i class="fas fa-check"></i> Approve
                                            </button>` : 
                                            req.status === 'approved' ? 
                                                `<span style="color: green;">Approved by ${req.approved_by}</span>` :
                                                '-'}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                content.innerHTML = html;
            }
            
            container.style.display = 'block';
        }
        
        function getStatusBadgeClass(status) {
            switch(status) {
                case 'pending': return 'bg-warning';
                case 'approved': return 'bg-success';
                case 'rejected': return 'bg-danger';
                default: return 'bg-secondary';
            }
        }
        
        function showCreateTripRequest() {
            document.getElementById('tripRequestsContainer').style.display = 'none';
            document.getElementById('createTripRequestContainer').style.display = 'block';
        }
        
        function cancelTripRequest() {
            document.getElementById('createTripRequestContainer').style.display = 'none';
            document.getElementById('tripRequestsContainer').style.display = 'block';
        }
        
        async function createTripRequest() {
            const department = document.getElementById('department').value;
            const requesterName = document.getElementById('requesterName').value;
            const purpose = document.getElementById('purpose').value;
            const destination = document.getElementById('destination').value;
            
            if (!department || !requesterName || !purpose || !destination) {
                showError('Please fill in all fields');
                return;
            }
            
            showLoading('Creating trip request...');
            
            try {
                const response = await fetch('/api/trip_requests', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ department, requester_name: requesterName, purpose, destination })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showSuccess('Trip request created successfully!');
                    cancelTripRequest();
                    loadTripRequests();
                } else {
                    showError(data.error || 'Failed to create trip request');
                }
            } catch (error) {
                showError('Error: ' + error.message);
            }
        }
        
        function showApproveRequest(requestId) {
            const approvedBy = prompt('Enter your name for approval:');
            const vehicleAssigned = prompt('Enter vehicle IMEI to assign:');
            
            if (!approvedBy || !vehicleAssigned) {
                showError('Both name and vehicle IMEI are required for approval');
                return;
            }
            
            approveTripRequest(requestId, approvedBy, vehicleAssigned);
        }
        
        async function approveTripRequest(requestId, approvedBy, vehicleAssigned) {
            showLoading('Approving trip request...');
            
            try {
                const response = await fetch(`/api/trip_requests/${requestId}/approve`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ approved_by: approvedBy, vehicle_assigned: vehicleAssigned })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showSuccess('Trip request approved successfully!');
                    loadTripRequests();
                } else {
                    showError(data.error || 'Failed to approve trip request');
                }
            } catch (error) {
                showError('Error: ' + error.message);
            }
        }
        
        function showVehicleManagement() {
            updateTitle('Vehicle Management');
            const html = `
                <div class="report-card">
                    <h4><i class="fas fa-list"></i> Vehicle Fleet</h4>
                    <div class="form-group">
                        <label for="vehicleStatus">Filter by Status:</label>
                        <select id="vehicleStatus" onchange="loadVehicles()">
                            <option value="">All Vehicles</option>
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                            <option value="maintenance">Maintenance</option>
                            <option value="retired">Retired</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="vehicleDepartment">Filter by Department:</label>
                        <input type="text" id="vehicleDepartment" placeholder="Enter department" onkeyup="loadVehicles()">
                    </div>
                    <button class="btn" onclick="loadVehicles()">
                        <i class="fas fa-search"></i> Load Vehicles
                    </button>
                    <button class="btn" onclick="showCreateVehicle()">
                        <i class="fas fa-plus"></i> Add New Vehicle
                    </button>
                    <div id="vehicleStatus"></div>
                </div>
                
                <div id="vehiclesContainer" style="display: none;">
                    <div class="report-card">
                        <h4><i class="fas fa-truck"></i> Vehicle List</h4>
                        <div id="vehiclesList"></div>
                    </div>
                </div>
            `;
            document.getElementById('reportsContent').innerHTML = html;
        }
        
        function showCreateVehicle() {
            updateTitle('Add New Vehicle');
            const html = `
                <div class="report-card">
                    <h4><i class="fas fa-plus"></i> Add New Vehicle</h4>
                    <div class="report-grid">
                        <div class="form-group">
                            <label for="newImei">IMEI *</label>
                            <input type="text" id="newImei" placeholder="Enter IMEI number" required>
                        </div>
                        <div class="form-group">
                            <label for="licensePlate">License Plate</label>
                            <input type="text" id="licensePlate" placeholder="Enter license plate">
                        </div>
                        <div class="form-group">
                            <label for="make">Make</label>
                            <input type="text" id="make" placeholder="e.g., Toyota">
                        </div>
                        <div class="form-group">
                            <label for="model">Model</label>
                            <input type="text" id="model" placeholder="e.g., Camry">
                        </div>
                        <div class="form-group">
                            <label for="year">Year</label>
                            <input type="number" id="year" placeholder="e.g., 2023" min="1900" max="2030">
                        </div>
                        <div class="form-group">
                            <label for="color">Color</label>
                            <input type="text" id="color" placeholder="e.g., White">
                        </div>
                        <div class="form-group">
                            <label for="vehicleType">Vehicle Type</label>
                            <select id="vehicleType">
                                <option value="">Select Type</option>
                                <option value="sedan">Sedan</option>
                                <option value="suv">SUV</option>
                                <option value="truck">Truck</option>
                                <option value="van">Van</option>
                                <option value="motorcycle">Motorcycle</option>
                                <option value="bus">Bus</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="driverName">Driver Name</label>
                            <input type="text" id="driverName" placeholder="Enter driver name">
                        </div>
                        <div class="form-group">
                            <label for="driverContact">Driver Contact</label>
                            <input type="text" id="driverContact" placeholder="Enter contact number">
                        </div>
                        <div class="form-group">
                            <label for="department">Department</label>
                            <input type="text" id="department" placeholder="Enter department">
                        </div>
                        <div class="form-group">
                            <label for="status">Status</label>
                            <select id="status">
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                                <option value="maintenance">Maintenance</option>
                                <option value="retired">Retired</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="fuelCapacity">Fuel Capacity (L)</label>
                            <input type="number" id="fuelCapacity" placeholder="Enter fuel capacity">
                        </div>
                        <div class="form-group">
                            <label for="currentFuel">Current Fuel (L)</label>
                            <input type="number" id="currentFuel" placeholder="Enter current fuel level">
                        </div>
                        <div class="form-group">
                            <label for="mileage">Mileage</label>
                            <input type="number" id="mileage" placeholder="Enter current mileage">
                        </div>
                        <div class="form-group">
                            <label for="lastServiceDate">Last Service Date</label>
                            <input type="date" id="lastServiceDate">
                        </div>
                        <div class="form-group">
                            <label for="nextServiceDate">Next Service Date</label>
                            <input type="date" id="nextServiceDate">
                        </div>
                        <div class="form-group">
                            <label for="insuranceExpiry">Insurance Expiry</label>
                            <input type="date" id="insuranceExpiry">
                        </div>
                        <div class="form-group">
                            <label for="registrationExpiry">Registration Expiry</label>
                            <input type="date" id="registrationExpiry">
                        </div>
                    </div>
                    <div style="margin-top: 1rem;">
                        <button class="btn" onclick="createVehicle()">
                            <i class="fas fa-save"></i> Save Vehicle
                        </button>
                        <button class="btn btn-secondary" onclick="showVehicleManagement()">
                            <i class="fas fa-arrow-left"></i> Back to List
                        </button>
                    </div>
                </div>
            `;
            document.getElementById('reportsContent').innerHTML = html;
        }
        
        function showVehicleStatistics() {
            updateTitle('Vehicle Statistics');
            const html = `
                <div class="report-card">
                    <h4><i class="fas fa-chart-pie"></i> Fleet Statistics</h4>
                    <button class="btn" onclick="loadVehicleStatistics()">
                        <i class="fas fa-refresh"></i> Load Statistics
                    </button>
                    <div id="statisticsStatus"></div>
                </div>
                
                <div id="statisticsContainer" style="display: none;">
                    <div class="report-card">
                        <h4><i class="fas fa-chart-bar"></i> Overview</h4>
                        <div id="statisticsOverview"></div>
                    </div>
                    
                    <div class="report-card">
                        <h4><i class="fas fa-chart-line"></i> Status Breakdown</h4>
                        <div id="statusBreakdown"></div>
                    </div>
                    
                    <div class="report-card">
                        <h4><i class="fas fa-building"></i> Department Breakdown</h4>
                        <div id="departmentBreakdown"></div>
                    </div>
                    
                    <div class="report-card">
                        <h4><i class="fas fa-car"></i> Vehicle Type Breakdown</h4>
                        <div id="typeBreakdown"></div>
                    </div>
                </div>
            `;
            document.getElementById('reportsContent').innerHTML = html;
        }
        
        // Vehicle Management Functions
        async function loadVehicles() {
            const status = document.getElementById('vehicleStatus').value;
            const department = document.getElementById('vehicleDepartment').value;
            
            showLoading('Loading vehicles...');
            
            try {
                const params = new URLSearchParams();
                if (status) params.append('status', status);
                if (department) params.append('department', department);
                
                const response = await fetch(`/api/vehicles?${params}`);
                const data = await response.json();
                
                if (response.ok) {
                    displayVehicles(data.vehicles);
                } else {
                    showError(data.error || 'Failed to load vehicles');
                }
            } catch (error) {
                showError('Error: ' + error.message);
            }
        }
        
        function displayVehicles(vehicles) {
            const container = document.getElementById('vehiclesContainer');
            const content = document.getElementById('vehiclesList');
            
            if (!vehicles || vehicles.length === 0) {
                content.innerHTML = '<p>No vehicles found.</p>';
            } else {
                const html = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>IMEI</th>
                                <th>License Plate</th>
                                <th>Make/Model</th>
                                <th>Driver</th>
                                <th>Department</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${vehicles.map(vehicle => `
                                <tr>
                                    <td>${vehicle.imei}</td>
                                    <td>${vehicle.license_plate || '-'}</td>
                                    <td>${vehicle.make || ''} ${vehicle.model || ''}</td>
                                    <td>${vehicle.driver_name || '-'}</td>
                                    <td>${vehicle.department || '-'}</td>
                                    <td><span class="badge ${getStatusBadgeClass(vehicle.status)}">${vehicle.status}</span></td>
                                    <td>
                                        <button class="btn" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;" onclick="viewVehicle(${vehicle.id})">
                                            <i class="fas fa-eye"></i> View
                                        </button>
                                        <button class="btn" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;" onclick="editVehicle(${vehicle.id})">
                                            <i class="fas fa-edit"></i> Edit
                                        </button>
                                        <button class="btn" style="padding: 0.25rem 0.5rem; font-size: 0.8rem; background: #dc3545;" onclick="deleteVehicle(${vehicle.id})">
                                            <i class="fas fa-trash"></i> Delete
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                content.innerHTML = html;
            }
            
            container.style.display = 'block';
        }
        
        async function createVehicle() {
            const vehicleData = {
                imei: document.getElementById('newImei').value,
                license_plate: document.getElementById('licensePlate').value,
                make: document.getElementById('make').value,
                model: document.getElementById('model').value,
                year: parseInt(document.getElementById('year').value) || null,
                color: document.getElementById('color').value,
                vehicle_type: document.getElementById('vehicleType').value,
                driver_name: document.getElementById('driverName').value,
                driver_contact: document.getElementById('driverContact').value,
                department: document.getElementById('department').value,
                status: document.getElementById('status').value,
                fuel_capacity: parseFloat(document.getElementById('fuelCapacity').value) || null,
                current_fuel: parseFloat(document.getElementById('currentFuel').value) || 0,
                mileage: parseFloat(document.getElementById('mileage').value) || 0,
                last_service_date: document.getElementById('lastServiceDate').value,
                next_service_date: document.getElementById('nextServiceDate').value,
                insurance_expiry: document.getElementById('insuranceExpiry').value,
                registration_expiry: document.getElementById('registrationExpiry').value
            };
            
            if (!vehicleData.imei) {
                showError('IMEI is required');
                return;
            }
            
            showLoading('Creating vehicle...');
            
            try {
                const response = await fetch('/api/vehicles', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(vehicleData)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showSuccess('Vehicle created successfully!');
                    showVehicleManagement();
                } else {
                    showError(data.error || 'Failed to create vehicle');
                }
            } catch (error) {
                showError('Error: ' + error.message);
            }
        }
        
        async function viewVehicle(vehicleId) {
            showLoading('Loading vehicle details...');
            
            try {
                const response = await fetch(`/api/vehicles/${vehicleId}`);
                const data = await response.json();
                
                if (response.ok) {
                    displayVehicleDetails(data.vehicle);
                } else {
                    showError(data.error || 'Failed to load vehicle');
                }
            } catch (error) {
                showError('Error: ' + error.message);
            }
        }
        
        function displayVehicleDetails(vehicle) {
            const html = `
                <div class="report-card">
                    <h4><i class="fas fa-info-circle"></i> Vehicle Details</h4>
                    <div class="report-grid">
                        <div class="stat-card">
                            <div class="stat-value">${vehicle.imei}</div>
                            <div class="stat-label">IMEI</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${vehicle.license_plate || '-'}</div>
                            <div class="stat-label">License Plate</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${vehicle.make || ''} ${vehicle.model || ''}</div>
                            <div class="stat-label">Make/Model</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${vehicle.year || '-'}</div>
                            <div class="stat-label">Year</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${vehicle.driver_name || '-'}</div>
                            <div class="stat-label">Driver</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${vehicle.department || '-'}</div>
                            <div class="stat-label">Department</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value"><span class="badge ${getStatusBadgeClass(vehicle.status)}">${vehicle.status}</span></div>
                            <div class="stat-label">Status</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${vehicle.mileage || 0}</div>
                            <div class="stat-label">Mileage</div>
                        </div>
                    </div>
                    <div style="margin-top: 1rem;">
                        <button class="btn btn-secondary" onclick="showVehicleManagement()">
                            <i class="fas fa-arrow-left"></i> Back to List
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('reportsContent').innerHTML = html;
        }
        
        function showEditVehicleForm(vehicle) {
            const html = `
                <div class="report-card">
                    <h4><i class="fas fa-edit"></i> Edit Vehicle</h4>
                    <form id="editVehicleForm" onsubmit="saveVehicle(event, ${vehicle.id})">
                        <div class="report-grid">
                            <div class="form-group">
                                <label>IMEI:</label>
                                <input type="text" name="imei" value="${vehicle.imei}" readonly>
                            </div>
                            <div class="form-group">
                                <label>License Plate:</label>
                                <input type="text" name="license_plate" value="${vehicle.license_plate || ''}">
                            </div>
                            <div class="form-group">
                                <label>Make:</label>
                                <input type="text" name="make" value="${vehicle.make || ''}">
                            </div>
                            <div class="form-group">
                                <label>Model:</label>
                                <input type="text" name="model" value="${vehicle.model || ''}">
                            </div>
                            <div class="form-group">
                                <label>Year:</label>
                                <input type="number" name="year" value="${vehicle.year || ''}" min="1900" max="2030">
                            </div>
                            <div class="form-group">
                                <label>Color:</label>
                                <input type="text" name="color" value="${vehicle.color || ''}">
                            </div>
                            <div class="form-group">
                                <label>Vehicle Type:</label>
                                <select name="vehicle_type">
                                    <option value="car" ${vehicle.vehicle_type === 'car' ? 'selected' : ''}>Car</option>
                                    <option value="truck" ${vehicle.vehicle_type === 'truck' ? 'selected' : ''}>Truck</option>
                                    <option value="van" ${vehicle.vehicle_type === 'van' ? 'selected' : ''}>Van</option>
                                    <option value="motorcycle" ${vehicle.vehicle_type === 'motorcycle' ? 'selected' : ''}>Motorcycle</option>
                                    <option value="bus" ${vehicle.vehicle_type === 'bus' ? 'selected' : ''}>Bus</option>
                                    <option value="other" ${vehicle.vehicle_type === 'other' ? 'selected' : ''}>Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Driver Name:</label>
                                <input type="text" name="driver_name" value="${vehicle.driver_name || ''}">
                            </div>
                            <div class="form-group">
                                <label>Driver Contact:</label>
                                <input type="text" name="driver_contact" value="${vehicle.driver_contact || ''}">
                            </div>
                            <div class="form-group">
                                <label>Department:</label>
                                <input type="text" name="department" value="${vehicle.department || ''}">
                            </div>
                            <div class="form-group">
                                <label>Status:</label>
                                <select name="status">
                                    <option value="active" ${vehicle.status === 'active' ? 'selected' : ''}>Active</option>
                                    <option value="inactive" ${vehicle.status === 'inactive' ? 'selected' : ''}>Inactive</option>
                                    <option value="maintenance" ${vehicle.status === 'maintenance' ? 'selected' : ''}>Maintenance</option>
                                    <option value="retired" ${vehicle.status === 'retired' ? 'selected' : ''}>Retired</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Fuel Capacity (L):</label>
                                <input type="number" name="fuel_capacity" value="${vehicle.fuel_capacity || ''}" step="0.1" min="0">
                            </div>
                            <div class="form-group">
                                <label>Current Fuel (L):</label>
                                <input type="number" name="current_fuel" value="${vehicle.current_fuel || ''}" step="0.1" min="0">
                            </div>
                            <div class="form-group">
                                <label>Mileage:</label>
                                <input type="number" name="mileage" value="${vehicle.mileage || ''}" min="0">
                            </div>
                            <div class="form-group">
                                <label>Last Service Date:</label>
                                <input type="date" name="last_service_date" value="${vehicle.last_service_date || ''}">
                            </div>
                            <div class="form-group">
                                <label>Next Service Date:</label>
                                <input type="date" name="next_service_date" value="${vehicle.next_service_date || ''}">
                            </div>
                            <div class="form-group">
                                <label>Insurance Expiry:</label>
                                <input type="date" name="insurance_expiry" value="${vehicle.insurance_expiry || ''}">
                            </div>
                            <div class="form-group">
                                <label>Registration Expiry:</label>
                                <input type="date" name="registration_expiry" value="${vehicle.registration_expiry || ''}">
                            </div>
                        </div>
                        <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Save Changes
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="showVehicleManagement()">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            document.getElementById('reportsContent').innerHTML = html;
        }
        
        async function saveVehicle(event, vehicleId) {
            event.preventDefault();
            
            const form = document.getElementById('editVehicleForm');
            const formData = new FormData(form);
            
            // Convert FormData to object
            const vehicleData = {};
            for (let [key, value] of formData.entries()) {
                if (value.trim() !== '') {
                    vehicleData[key] = value;
                }
            }
            
            showLoading('Saving vehicle...');
            
            try {
                const response = await fetch(`/api/vehicles/${vehicleId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(vehicleData)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showSuccess('Vehicle updated successfully!');
                    showVehicleManagement();
                } else {
                    showError(data.error || 'Failed to update vehicle');
                }
            } catch (error) {
                showError('Error: ' + error.message);
            }
        }
        
        function editVehicle(vehicleId) {
            // Load vehicle data and show edit form
            showLoading('Loading vehicle for editing...');
            
            fetch(`/api/vehicles/${vehicleId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to load vehicle');
                    }
                    return response.json();
                })
                .then(data => {
                    showEditVehicleForm(data.vehicle);
                })
                .catch(error => {
                    showError('Error: ' + error.message);
                });
        }
        
        async function deleteVehicle(vehicleId) {
            if (!confirm('Are you sure you want to delete this vehicle?')) {
                return;
            }
            
            showLoading('Deleting vehicle...');
            
            try {
                const response = await fetch(`/api/vehicles/${vehicleId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showSuccess('Vehicle deleted successfully!');
                    loadVehicles();
                } else {
                    showError(data.error || 'Failed to delete vehicle');
                }
            } catch (error) {
                showError('Error: ' + error.message);
            }
        }
        
        async function loadVehicleStatistics() {
            showLoading('Loading vehicle statistics...');
            
            try {
                const response = await fetch('/api/vehicles/statistics');
                const data = await response.json();
                
                if (response.ok) {
                    displayVehicleStatistics(data.statistics);
                } else {
                    showError(data.error || 'Failed to load statistics');
                }
            } catch (error) {
                showError('Error: ' + error.message);
            }
        }
        
        function displayVehicleStatistics(stats) {
            const container = document.getElementById('statisticsContainer');
            
            // Overview
            const overviewHtml = `
                <div class="report-grid">
                    <div class="stat-card">
                        <div class="stat-value">${stats.total_vehicles}</div>
                        <div class="stat-label">Total Vehicles</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.status_counts.active || 0}</div>
                        <div class="stat-label">Active Vehicles</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.status_counts.maintenance || 0}</div>
                        <div class="stat-label">In Maintenance</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${Object.keys(stats.department_counts).length}</div>
                        <div class="stat-label">Departments</div>
                    </div>
                </div>
            `;
            document.getElementById('statisticsOverview').innerHTML = overviewHtml;
            
            // Status breakdown
            const statusHtml = `
                <div class="report-grid">
                    ${Object.entries(stats.status_counts).map(([status, count]) => `
                        <div class="stat-card">
                            <div class="stat-value">${count}</div>
                            <div class="stat-label">${status.charAt(0).toUpperCase() + status.slice(1)}</div>
                        </div>
                    `).join('')}
                </div>
            `;
            document.getElementById('statusBreakdown').innerHTML = statusHtml;
            
            // Department breakdown
            const deptHtml = `
                <div class="report-grid">
                    ${Object.entries(stats.department_counts).map(([dept, count]) => `
                        <div class="stat-card">
                            <div class="stat-value">${count}</div>
                            <div class="stat-label">${dept}</div>
                        </div>
                    `).join('')}
                </div>
            `;
            document.getElementById('departmentBreakdown').innerHTML = deptHtml;
            
            // Vehicle type breakdown
            const typeHtml = `
                <div class="report-grid">
                    ${Object.entries(stats.vehicle_type_counts).map(([type, count]) => `
                        <div class="stat-card">
                            <div class="stat-value">${count}</div>
                            <div class="stat-label">${type}</div>
                        </div>
                    `).join('')}
                </div>
            `;
            document.getElementById('typeBreakdown').innerHTML = typeHtml;
            
            container.style.display = 'block';
        }
        
        // Vehicle Dropdown Loading Function
        async function loadVehicleDropdown(dropdownId) {
            try {
                const response = await fetch('/api/vehicles');
                const data = await response.json();
                
                if (response.ok && data.vehicles) {
                    const dropdown = document.getElementById(dropdownId);
                    if (dropdown) {
                        // Clear existing options except the first one
                        dropdown.innerHTML = dropdown.options.length > 0 ? dropdown.options[0].outerHTML : '';
                        
                        // Add vehicle options
                        data.vehicles.forEach(vehicle => {
                            const option = document.createElement('option');
                            option.value = vehicle.imei;
                            option.textContent = `${vehicle.make || 'Unknown'} ${vehicle.model || ''} (${vehicle.imei})`;
                            dropdown.appendChild(option);
                        });
                    }
                }
            } catch (error) {
                console.error('Error loading vehicles:', error);
            }
        }
        
        function showLiveMap() {
            updateTitle('Live Vehicle Tracking');
            const content = `
                <div class="report-card">
                    <h4><i class="fas fa-map-marked-alt"></i> Live Vehicle Tracking</h4>
                    <div id="map" style="height: 500px; border-radius: 8px;"></div>
                </div>
            `;
            document.getElementById('reportsContent').innerHTML = content;
            
            // Initialize map
            setTimeout(() => {
                initializeMap();
                updateMarkers();
                setInterval(updateMarkers, 5000);
            }, 100);
        }
        
        function showSuccess(message) {
            document.getElementById('reportStatus').innerHTML = `<div class="success"><i class="fas fa-check-circle"></i> ${message}</div>`;
        }
        
        function initializeMap() {
            if (map) return;
            
            const mapElement = document.getElementById('map');
            if (!mapElement) return;
            
            map = L.map(mapElement).setView([9.03, 38.74], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19
            }).addTo(map);
        }
        
        async function updateMarkers() {
            if (!map) return;
            
            try {
                const response = await fetch('/api/latest');
                const data = await response.json();
                
                if (data.length > 0) {
                    const first = data[0];
                    map.setView([first.lat, first.lon], 13);
                }
                
                data.forEach(p => {
                    const key = p.imei;
                    const plateDisplay = p.license_plate || 'Unknown Vehicle';
                    if (markers[key]) {
                        markers[key].setLatLng([p.lat, p.lon]);
                    } else {
                        markers[key] = L.marker([p.lat, p.lon]).addTo(map)
                            .bindPopup(`Vehicle: ${plateDisplay}<br>Speed: ${p.speed} km/h`);
                    }
                });
            } catch (error) {
                console.error('Error updating markers:', error);
            }
        }
        
        function showLoading(message) {
            document.getElementById('reportStatus').innerHTML = `<div class="loading"><i class="fas fa-spinner fa-spin"></i> ${message}</div>`;
        }
        
        function showError(message) {
            document.getElementById('reportStatus').innerHTML = `<div class="error"><i class="fas fa-exclamation-triangle"></i> ${message}</div>`;
        }
        
        function updateTitle(title) {
            document.getElementById('reportTitle').textContent = title;
        }
    </script>
</body>
</html>
